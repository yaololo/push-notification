## Push Notifications

Push notification service make use of two API

- the Notification API to display the messages
- the Push API to handle the messages that are pushed to the client from the server via Push service used by browser

###### Service Worker

> A Service Worker is programmable proxy between your web page and the network, providing the ability to intercept and cache network requests, effectively giving you the ability to create an offline-first experience for your app. (**_Source_** : [Service Workers explained](https://flaviocopes.com/service-workers/))

A service worker is a piece of Javascript code that runs at the background of client's browser.

Common useage of service worker will be:

> - Background data synchronization
> - Responding to resource requests from other origins
> - Receiving centralized updates to expensive-to-calculate data such as geolocation or gyroscope, so multiple pages can make use of one set of data
> - Client-side compiling and dependency management of CoffeeScript, less, CJS/AMD modules, etc. for dev purposes
> - Hooks for background services
> - Custom templating based on certain URL patterns
> - Performance enhancements, for example pre-fetching resources that the user is likely to need in the near future, such as the next few pictures in a photo album.
> - Reacting to push message
>   ( **_Source_** : [Service Worker API - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API) )
>   <br>

Life cycle of service worker on its first installation

> ![Screen Shot 2018-07-27 at 4.44.52 PM.png](push-notification/public/SWlifecycle.png)
> (**_Source_**: [Service Workers: an Introduction  |  Web Fundamentals  |  Google Developers](https://developers.google.com/web/fundamentals/primers/service-workers/))

In general the life cycle will be:

1.  Download
2.  Install
3.  Activate

###### Work flows of push notifications:

1.  client side allows the notification service and it will subscribe for notification service. The `'subscription'` will be sent to the application server. - the `'subscription'` format will be like this

    ```js
      {
        endpoint:  
        expirationTime: null,
        keys: {
          p256dh: (string) ,
          auth: ()
        }
      }
    ```

2.  Send subscription to application server. Server will save all the subscriptions from different users in database.
3.  Push notifications to users by using the subscriptions collected previously. (A push event is sent to client side)
4.  Service workers will always be listening to the push event and act accordingly once the push event is triggered.
    <br>

###### Setup your own push notification service with Node.js and Express.js

You need to have node environment for this tutorial

    `npm init`
    Run `npm i express web-push body-parser` to install express, web-push and body-parser library
    In package.json file put in the follwoing code
    "scripts": {
      "start": "node index.js"
    }

step 1:
Create client folder and create client.js inside the folder.
We first need to check if the user browser support service worker, if the service worker support servive worker, wen then need to register the service worker.

Keys are generated by command `./node_modules/.bin/web-push generate-vapid-keys`. You need to hide the keys. Public key is used by both client and server. Private key is only used by server (is used in step 2)

```js
const publicVapidKey =
  "BJthRQ5myDgc7OSXzPCMftGw-n16F7zQBEN7EUD6XxcfTTvrLGWSIG7y_JxiWtVlCFua0S8MTB5rPziBqNx1qIo";

// check if the browser support service worker
if ("serviceWorker" in navigator) {
  //if support call send()
  send().catch(err => console.error(err));
}

// Register SW, Register Push, Send Push
async function send() {
  // Register Service Worker
  const register = await navigator.serviceWorker.register("/worker.js", {
    scope: "/"
    //scope will indicate from which directory that service worker registered. worker.js is the service worker file
  });
  console.log("Service Worker Registered...");

  // Register Push using Push API
  const subscription = await register.pushManager.subscribe({
    userVisibleOnly: true, //to indicate the notification is visible (not a silent push notification)
    applicationServerKey: urlBase64ToUint8Array(publicVapidKey) //encripted public key is sent to server, it must match the public key on server side
  });
  console.log("Push Registered...");
  //subscription now has an endpoint and keys

  // Send registered subscription to server
  await fetch("/subscribe", {
    method: "POST",
    body: JSON.stringify(subscription),
    headers: {
      "content-type": "application/json"
    }
  });
  console.log("Push Sent...");
}

//public key encription function
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding)
    .replace(/\-/g, "+")
    .replace(/_/g, "/");

  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}
```

Step 2: Screate index.js

Create index.js file at root directory. This will be the exoress server file that handle user subscriptions and the push notifications to users.

```javascript
const express = require("express");
const webpush = require("web-push");
const bodyParser = require("body-parser");
const path = require("path");

const app = express();

// Set static path
app.use(express.static(path.join(__dirname, "client")));

app.use(bodyParser.json());

const publicVapidKey =
  "BJthRQ5myDgc7OSXzPCMftGw-n16F7zQBEN7EUD6XxcfTTvrLGWSIG7y_JxiWtVlCFua0S8MTB5rPziBqNx1qIo";
const privateVapidKey = "3KzvKasA2SoCxsp0iIG_o9B0Ozvl1XDwI63JRKNIWBM";

webpush.setVapidDetails(
  "mailto:test@test.com",
  publicVapidKey,
  privateVapidKey
); //I think the keys are used for verification of user subscription.

// Subscribe Route
app.post("/subscribe", (req, res) => {
  // Get subscription object, the subscription is sent from client.js and it is the payload of a fetch method. It contians an endpoint and keys
  const subscription = req.body;

  // Send 201 - resource created
  res.status(201).json({});

  // Create payload which contains some information that is sent to service worker
  const payload = JSON.stringify({ title: "Push Test" });

  //verify subscription and send payload
  webpush
    .sendNotification(subscription, payload)
    .catch(err => console.error(err));
});

const port = 5000;

app.listen(port, () => console.log(`Server started on port` + port));
```

step 3:

Create worker.js in client folder.

```js
//service worker will always listen to "push" event
self.addEventListener("push", e => {
  const data = e.data.json();
  console.log("Push Recieved...");
  // data.title is the payload sent by server, it will be the title of the notification
  self.registration.showNotification(data.title, {
    body: "Notified by Traversy Media!", //body of the notification
    icon: "http://image.ibb.co/frYOFd/tmlogo.png"
  });
});
```

stpe 4:

Now run `npm run start` and go to `localhost:5000` in your browser, you should receive a notification.

<br>

Credit to :

- [YouTube](https://www.youtube.com/watch?v=HlYFW2zaYQM&t=423s&pbjreload=10)

- [Intro to Web Push Notifications with English - CC subtitles (closed captions) and transcript](http://www.yousubtitles.com/Intro-to-Web-Push-Notifications-id-1210061)

Please spend some time to watch the video, especially the second video to understand more about service worker.
